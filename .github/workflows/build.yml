# Nombre del flujo de trabajo de GitHub Actions
name: Compilar Kernel (Vayu)

on:
  workflow_dispatch: # Permite iniciar la compilación manualmente

jobs:
  # TRABAJO 1: Generar la matriz de compilación desde repos.json
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Generar matriz para los trabajos de compilación
        id: set-matrix
        run: |
          JSON_MATRIX=$(jq -c '.' repos.json)
          echo "matrix={\"include\":${JSON_MATRIX}}" >> $GITHUB_OUTPUT

  # TRABAJO 2: Compilar cada kernel definido en la matriz
  build-kernel:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential libncurses-dev bison flex libssl-dev libelf-dev bc ccache \
            jq git zip device-tree-compiler

      - name: Crear directorios de trabajo
        run: mkdir -p toolchains

      - name: Clonar Toolchains
        run: |
          TOOLCHAINS_JSON='${{ toJSON(matrix.toolchains) }}'
          echo "$TOOLCHAINS_JSON" | jq -c '.[]' | while read -r toolchain; do
            repo=$(echo "$toolchain" | jq -r '.repo')
            branch=$(echo "$toolchain" | jq -r '.branch')
            name=$(echo "$toolchain" | jq -r '.name')
            git clone --depth=1 -b "$branch" "$repo" "toolchains/$name"
          done

      - name: Configurar entorno (PATH y ccache)
        run: |
          for dir in toolchains/*/bin; do [ -d "$dir" ] && echo "$(pwd)/$dir" >> $GITHUB_PATH; done
          ccache -M 50G
          ccache -z
          
      - name: Clonar fuente del Kernel y submódulos
        run: |
          git clone --depth=1 -b ${{ matrix.kernelSource.branch }} ${{ matrix.kernelSource.repo }} kernel_source
          cd kernel_source
          if [ "${{ matrix.withKernelSU }}" = "true" ]; then
            git submodule init
            git submodule update
          fi

      - name: Construir argumentos de compilación
        id: build_args
        run: |
          PARAMS_JSON='${{ toJSON(matrix.params) }}'
          ARGS_STRING=$(echo "$PARAMS_JSON" | jq -r 'to_entries | .[] | .key + "=\"" + .value + "\""' | tr '\n' ' ')
          echo "args=${ARGS_STRING}" >> $GITHUB_OUTPUT

      - name: Generar defconfig
        working-directory: ./kernel_source
        run: |
          # Primero, genera el defconfig base
          make O=../out ${{ steps.build_args.outputs.args }} ${{ matrix.kernelSource.defconfig }}
          
          # Si se especifica KernelSU, habilítalo en la config y actualiza
          if [ "${{ matrix.withKernelSU }}" = "true" ]; then
            echo "CONFIG_KSU=y" >> ../out/.config
            make O=../out ${{ steps.build_args.outputs.args }} olddefconfig
          fi

      - name: Compilar Kernel
        working-directory: ./kernel_source
        env:
          KBUILD_BUILD_USER: "t.me"
          KBUILD_BUILD_HOST: "AnymoreProject"
        run: |
          make O=../out -j$(nproc --all) ${{ steps.build_args.outputs.args }}

      - name: Empaquetar con AnyKernel3
        run: |
          if ! [ -f "out/arch/${{ matrix.params.ARCH }}/boot/Image" ]; then
            echo "Error: La compilación falló, no se encontró el archivo Image."
            exit 1
          fi
          git clone --depth 1 https://github.com/osm0sis/AnyKernel3.git
          cp out/arch/${{ matrix.params.ARCH }}/boot/Image AnyKernel3/
          cp out/arch/${{ matrix.params.ARCH }}/boot/dtbo.img AnyKernel3/ 2>/dev/null || true
          cd AnyKernel3
          zip -r9 "../${{ matrix.kernelSource.name }}.zip" .
          cd ..

      - name: Subir artefacto (Zip Flasheable)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.kernelSource.name }}
          path: ${{ matrix.kernelSource.name }}.zip

